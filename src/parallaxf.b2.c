#include <gb/gb.h>

extern const unsigned char ParallaxTiles[];
extern const unsigned int Parallax_TableX[];
extern const unsigned char Parallax_TableY[];

int ParaOffsetX;
int ParaOffsetY;
UINT8 pbank;
UINT8 Parallax;
UINT8 SX;
UINT8 SY;

void DMA_TRANSFER(UINT16 *source,UINT16 *destination); 
void CPU_TRANSFER(UINT16 *source,UINT16 *destination);

void Update_Parallax(){
	//So.. This ensures the data to be copied well, but it has 1 pixel delay.
	//It's better a delay, than garbage on the top of the screen I guess.
	if (Parallax == 2) {
		SWITCH_ROM_MBC1(pbank);
		DMA_TRANSFER(0xD000,0x9000);
	}
}
void Reset_Parallaxf(UINT8 bank){
	ParaOffsetX = 0;
	ParaOffsetY = 0;
	Parallax = 0;
	//Copy Tiles to Ram 
	CPU_TRANSFER(&ParallaxTiles+ParaOffsetX+ParaOffsetY,0xD000); 
	pbank = bank;
	//Update VRAM
	add_VBL(Update_Parallax);
}

void Move_Parallaxf(){
	
	if (Parallax == 2){
		SX = SCX_REG;
		ParaOffsetX = Parallax_TableX[SX]; 
		SY = SCY_REG;
		ParaOffsetY = Parallax_TableY[SY];
		
		//Prepare data for the DMA (Next frame)
		//This can be done while drawing
		CPU_TRANSFER(&ParallaxTiles+ParaOffsetX+ParaOffsetY,0xD000); //Copy Tiles to VRam 
		
		Parallax = 0;
	}
	Parallax++; 
}
//Offsets for all frames of the parallax animation
const unsigned int Parallax_TableX[] =
{
	3584+192,3584+192,3072+192,3072+192,2560+192,2560+192,2048+192,2048+192,1536+192,1536+192,1024+192,1024+192,512+192,512+192,0+192,0+192,
	3584+128,3584+128,3072+128,3072+128,2560+128,2560+128,2048+128,2048+128,1536+128,1536+128,1024+128,1024+128,512+128,512+128,0+128,0+128,
	3584+64,3584+64,3072+64,3072+64,2560+64,2560+64,2048+64,2048+64,1536+64,1536+64,1024+64,1024+64,512+64,512+64,0+64,0+64,
	3584,3584,3072,3072,2560,2560,2048,2048,1536,1536,1024,1024,512,512,0,0,
	3584+192,3584+192,3072+192,3072+192,2560+192,2560+192,2048+192,2048+192,1536+192,1536+192,1024+192,1024+192,512+192,512+192,0+192,0+192,
	3584+128,3584+128,3072+128,3072+128,2560+128,2560+128,2048+128,2048+128,1536+128,1536+128,1024+128,1024+128,512+128,512+128,0+128,0+128,
	3584+64,3584+64,3072+64,3072+64,2560+64,2560+64,2048+64,2048+64,1536+64,1536+64,1024+64,1024+64,512+64,512+64,0+64,0+64,
	3584,3584,3072,3072,2560,2560,2048,2048,1536,1536,1024,1024,512,512,0,0,
	3584+192,3584+192,3072+192,3072+192,2560+192,2560+192,2048+192,2048+192,1536+192,1536+192,1024+192,1024+192,512+192,512+192,0+192,0+192,
	3584+128,3584+128,3072+128,3072+128,2560+128,2560+128,2048+128,2048+128,1536+128,1536+128,1024+128,1024+128,512+128,512+128,0+128,0+128,
	3584+64,3584+64,3072+64,3072+64,2560+64,2560+64,2048+64,2048+64,1536+64,1536+64,1024+64,1024+64,512+64,512+64,0+64,0+64,
	3584,3584,3072,3072,2560,2560,2048,2048,1536,1536,1024,1024,512,512,0,0,
	3584+192,3584+192,3072+192,3072+192,2560+192,2560+192,2048+192,2048+192,1536+192,1536+192,1024+192,1024+192,512+192,512+192,0+192,0+192,
	3584+128,3584+128,3072+128,3072+128,2560+128,2560+128,2048+128,2048+128,1536+128,1536+128,1024+128,1024+128,512+128,512+128,0+128,0+128,
	3584+64,3584+64,3072+64,3072+64,2560+64,2560+64,2048+64,2048+64,1536+64,1536+64,1024+64,1024+64,512+64,512+64,0+64,0+64,
	3584,3584,3072,3072,2560,2560,2048,2048,1536,1536,1024,1024,512,512,0,0,
};

const unsigned char Parallax_TableY[] =
{
	31,31,30,30,29,29,28,28,27,27,26,26,25,25,24,24,23,23,22,22,21,21,20,20,19,19,18,18,17,17,16,16,15,15,
	14,14,13,13,12,12,11,11,10,10,9,9,8,8,7,7,6,6,5,5,4,4,3,3,2,2,1,1,0,0,
	31,31,30,30,29,29,28,28,27,27,26,26,25,25,24,24,23,23,22,22,21,21,20,20,19,19,18,18,17,17,16,16,15,15,
	14,14,13,13,12,12,11,11,10,10,9,9,8,8,7,7,6,6,5,5,4,4,3,3,2,2,1,1,0,0,
	31,31,30,30,29,29,28,28,27,27,26,26,25,25,24,24,23,23,22,22,21,21,20,20,19,19,18,18,17,17,16,16,15,15,
	14,14,13,13,12,12,11,11,10,10,9,9,8,8,7,7,6,6,5,5,4,4,3,3,2,2,1,1,0,0,
	31,31,30,30,29,29,28,28,27,27,26,26,25,25,24,24,23,23,22,22,21,21,20,20,19,19,18,18,17,17,16,16,15,15,
	14,14,13,13,12,12,11,11,10,10,9,9,8,8,7,7,6,6,5,5,4,4,3,3,2,2,1,1,0,0
};


